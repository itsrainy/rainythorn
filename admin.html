<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Wedding RSVPs</title>
    <link rel="stylesheet" href="styles.css?v=20251220">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .admin-header h1 {
            font-family: 'Playfair Display', serif;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        
        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-login h2 {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
        }
        
        .admin-login input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .admin-login button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .admin-login .error {
            color: #c0392b;
            text-align: center;
            margin-top: 10px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Playfair Display', serif;
        }
        
        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* Activity Feed */
        .activity-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .activity-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-header h2 {
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .refresh-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .refresh-btn:hover {
            background: var(--sage-light);
        }
        
        .activity-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-item.attending {
            border-left: 4px solid #27ae60;
        }
        
        .activity-item.declined {
            border-left: 4px solid #c0392b;
        }
        
        .activity-item.partial {
            border-left: 4px solid #f39c12;
        }
        
        .activity-household {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .activity-guests {
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        
        .activity-guests .attending-yes {
            color: #27ae60;
        }
        
        .activity-guests .attending-no {
            color: #c0392b;
        }
        
        .activity-events {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 8px;
        }
        
        .activity-notes {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 10px;
            background: var(--sage-light);
            border-radius: var(--border-radius);
        }
        
        .activity-dietary {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .no-responses {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }
        
        /* Guest List Table */
        .guest-table-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 30px;
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table-header h2 {
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .guest-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .guest-table th,
        .guest-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .guest-table th {
            background: var(--sage-light);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .guest-table tr:hover {
            background: #fafafa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.yes {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.no {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.viewed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Needs Email Section */
        .needs-email-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .needs-email-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .needs-email-header h2 {
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .needs-email-count {
            background: #fff3cd;
            color: #856404;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .needs-email-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .needs-email-item {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .needs-email-item:hover {
            background: #fafafa;
        }
        
        .needs-email-item:last-child {
            border-bottom: none;
        }
        
        .needs-email-info h4 {
            margin: 0 0 4px 0;
            font-weight: 600;
        }
        
        .needs-email-info p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .add-email-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .add-email-btn:hover {
            background: #7a6548;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            width: 90%;
            max-width: 450px;
            border-radius: var(--border-radius);
            padding: 30px;
            animation: modalIn 0.2s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal h3 {
            font-family: 'Playfair Display', serif;
            margin: 0 0 5px 0;
        }
        
        .modal-guests {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .modal input[type="email"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .modal input[type="email"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-cancel {
            background: #f0f0f0;
            border: none;
            color: var(--text-dark);
        }
        
        .btn-send {
            background: var(--primary-color);
            border: none;
            color: white;
        }
        
        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-edit {
            background: none;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .btn-edit:hover {
            background: var(--sage-light);
            color: var(--text-dark);
        }
        
        .modal-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
            display: none;
        }
        
        .modal-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }
        
        .modal-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal-status.loading {
            display: block;
            background: #e3f2fd;
            color: #1565c0;
        }
    </style>
</head>
<body style="background: #f8f6f3;">
    <!-- Login Screen -->
    <div id="admin-login" class="admin-login">
        <h2>Admin Access</h2>
        <input type="password" id="admin-password" placeholder="Enter admin password">
        <button onclick="attemptLogin()">Login</button>
        <p id="login-error" class="error hidden"></p>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-container hidden">
        <div class="admin-header">
            <h1>Wedding RSVP Dashboard</h1>
            <p>Rainy & Thorn ¬∑ May 23rd, 2026</p>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="stat-total-invited">-</div>
                <div class="label">Total Invited</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-responded">-</div>
                <div class="label">Households Responded</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-attending">-</div>
                <div class="label">Guests Attending</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-declined">-</div>
                <div class="label">Declined</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-welcome-party">-</div>
                <div class="label">Welcome Party</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-wedding">-</div>
                <div class="label">Wedding</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-helpers">-</div>
                <div class="label">Setup Helpers</div>
            </div>
        </div>
        
        <!-- Needs Email Section -->
        <div class="needs-email-section" id="needs-email-section">
            <div class="needs-email-header">
                <h2>üìß Needs Email</h2>
                <span class="needs-email-count" id="needs-email-count">0</span>
                <button class="btn-add-new" onclick="openNewHouseholdModal()" style="margin-left: auto; padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem;">+ Add New Household</button>
            </div>
            <div class="needs-email-list" id="needs-email-list">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="activity-section">
            <div class="activity-header">
                <h2>Recent Responses</h2>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="activity-list" class="activity-list">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Full Guest List -->
        <div class="guest-table-section">
            <div class="table-header">
                <h2>All Guests</h2>
            </div>
            <div style="overflow-x: auto;">
                <table class="guest-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Household</th>
                            <th style="width: 60px;"></th>
                            <th>Status</th>
                            <th>Dietary</th>
                            <th>Welcome Party</th>
                            <th>Wedding</th>
                        </tr>
                    </thead>
                    <tbody id="guest-table-body">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Add Email Modal -->
    <div class="modal-overlay" id="email-modal" onclick="closeModalIfOverlay(event)">
        <div class="modal">
            <h3 id="modal-household-name">Household Name</h3>
            <p class="modal-guests" id="modal-guests">Guest names</p>
            <input type="email" id="modal-email-input" placeholder="Enter email address" autocomplete="email">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-send" id="modal-send-btn" onclick="sendInvitation()">Send Invite</button>
            </div>
            <div class="modal-status" id="modal-status"></div>
        </div>
    </div>
    
    <!-- Add New Household Modal -->
    <div class="modal-overlay" id="new-household-modal" onclick="closeNewHouseholdModalIfOverlay(event)">
        <div class="modal" style="max-width: 500px;">
            <h3>Add New Household</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Household Name</label>
                <input type="text" id="new-household-name" placeholder="e.g., John & Jane Smith" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
                <input type="email" id="new-household-email" placeholder="email@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Guest Names (one per line)</label>
                <textarea id="new-household-guests" placeholder="John Smith&#10;Jane Smith" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); resize: vertical;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-household-plus-one">
                    <span>Allow +1</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeNewHouseholdModal()">Cancel</button>
                <button class="btn-send" id="new-household-save-btn" onclick="saveNewHousehold()">Create & Send Invite</button>
            </div>
            <div class="modal-status" id="new-household-status"></div>
        </div>
    </div>
    
    <!-- Edit Household Modal -->
    <div class="modal-overlay" id="edit-household-modal" onclick="closeEditHouseholdModalIfOverlay(event)">
        <div class="modal" style="max-width: 500px;">
            <h3 id="edit-household-title">Edit Household</h3>
            <p class="modal-guests" id="edit-household-guests">Guest names</p>
            
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="edit-allows-plus-one">
                    <span>Allow +1</span>
                </label>
                <p style="font-size: 12px; color: var(--muted-color); margin-top: 5px;">If enabled, household can add a +1 during RSVP</p>
            </div>
            
            <div id="edit-plus-one-section" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Plus One Name (optional)</label>
                <input type="text" id="edit-plus-one-name" placeholder="Enter +1 name manually" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                <p style="font-size: 12px; color: var(--muted-color); margin-top: 5px;">Leave empty to let guest enter during RSVP</p>
            </div>
            
            <div id="edit-plus-one-dietary-section" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Plus One Dietary Restrictions</label>
                <input type="text" id="edit-plus-one-dietary" placeholder="Any dietary restrictions" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
            </div>
            
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Add Guest to Household</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="add-guest-first-name" placeholder="First name" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                    <input type="text" id="add-guest-last-name" placeholder="Last name" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                </div>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="add-guest-is-child">
                        <span>Child</span>
                    </label>
                    <button type="button" class="btn-send" style="padding: 8px 16px;" onclick="addGuestToHousehold()">Add Guest</button>
                </div>
            </div>
            
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Send Invitation</label>
                <p id="edit-invite-status" style="font-size: 12px; color: var(--muted-color); margin-bottom: 10px;"></p>
                <button type="button" class="btn-send" style="padding: 8px 16px;" onclick="resendInvitation()">Send Invitation Email</button>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditHouseholdModal()">Cancel</button>
                <button class="btn-send" id="edit-household-save-btn" onclick="saveHouseholdEdit()">Save Changes</button>
            </div>
            <div class="modal-status" id="edit-household-status"></div>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://zebjmroualsnbnmibzce.supabase.co';
        const SUPABASE_SERVICE_KEY = ''; // Will be entered at login
        let supabaseClient = null;
        let allInvites = [];
        let selectedInvite = null;
        
        function attemptLogin() {
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('login-error');
            
            // The password IS the service key - simple but effective
            // Only someone with the service key can access admin
            if (!password || password.length < 20) {
                errorEl.textContent = 'Please enter the service role key';
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Try to initialize Supabase with the key
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, password);
                
                // Test the connection by fetching data
                testConnection(password);
            } catch (e) {
                errorEl.textContent = 'Invalid key';
                errorEl.classList.remove('hidden');
            }
        }
        
        async function testConnection(key) {
            const errorEl = document.getElementById('login-error');
            
            try {
                const { data, error } = await supabaseClient.from('invites').select('id').limit(1);
                
                if (error) {
                    errorEl.textContent = 'Access denied: ' + error.message;
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                // Success! Show dashboard
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                // Store key for session (not persistent)
                sessionStorage.setItem('adminKey', key);
                
                loadData();
            } catch (e) {
                errorEl.textContent = 'Connection failed';
                errorEl.classList.remove('hidden');
            }
        }
        
        async function loadData() {
            if (!supabaseClient) return;
            
            try {
                // Fetch all invites with guests
                const { data: invites, error } = await supabaseClient
                    .from('invites')
                    .select(`
                        *,
                        guests(*)
                    `)
                    .order('updated_at', { ascending: false, nullsFirst: false });
                
                if (error) throw error;
                
                allInvites = invites;
                updateStats(invites);
                renderNeedsEmail(invites);
                renderActivityFeed(invites);
                renderGuestTable(invites);
                
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        function updateStats(invites) {
            let totalGuests = 0;
            let respondedHouseholds = 0;
            let attendingGuests = 0;
            let declinedHouseholds = 0;
            let welcomePartyCount = 0;
            let weddingCount = 0;
            let helpersCount = 0;
            
            invites.forEach(invite => {
                const guestCount = invite.guests?.length || 0;
                totalGuests += guestCount;
                
                if (invite.submitted_at) {
                    respondedHouseholds++;
                    
                    // Count attending guests
                    let householdAttending = 0;
                    invite.guests?.forEach(g => {
                        if (g.attending) {
                            attendingGuests++;
                            householdAttending++;
                        }
                    });
                    
                    // Count plus ones
                    if (invite.plus_one_name) {
                        attendingGuests++;
                        householdAttending++;
                    }
                    
                    // Check if this household declined (no one attending)
                    if (householdAttending === 0) {
                        declinedHouseholds++;
                    }
                    
                    // Event counts (per household attending)
                    const anyoneAttending = invite.guests?.some(g => g.attending) || invite.plus_one_name;
                    if (anyoneAttending) {
                        if (invite.welcome_party) welcomePartyCount += invite.guests?.filter(g => g.attending).length + (invite.plus_one_name ? 1 : 0);
                        if (invite.wedding) weddingCount += invite.guests?.filter(g => g.attending).length + (invite.plus_one_name ? 1 : 0);
                    }
                    
                    if (invite.setup_teardown_interest) helpersCount++;
                }
            });
            
            document.getElementById('stat-total-invited').textContent = totalGuests;
            document.getElementById('stat-responded').textContent = respondedHouseholds + '/' + invites.length;
            document.getElementById('stat-attending').textContent = attendingGuests;
            document.getElementById('stat-declined').textContent = declinedHouseholds;
            document.getElementById('stat-welcome-party').textContent = welcomePartyCount;
            document.getElementById('stat-wedding').textContent = weddingCount;
            document.getElementById('stat-helpers').textContent = helpersCount;
        }
        
        function renderActivityFeed(invites) {
            const container = document.getElementById('activity-list');
            
            // Filter to only responded invites, sorted by most recent
            const responded = invites
                .filter(i => i.submitted_at)
                .sort((a, b) => new Date(b.updated_at || b.submitted_at) - new Date(a.updated_at || a.submitted_at));
            
            if (responded.length === 0) {
                container.innerHTML = '<div class="no-responses">No responses yet</div>';
                return;
            }
            
            container.innerHTML = responded.map(invite => {
                const guests = invite.guests || [];
                const attendingGuests = guests.filter(g => g.attending);
                const decliningGuests = guests.filter(g => g.attending === false);
                
                // Determine status class
                let statusClass = 'declined';
                if (attendingGuests.length === guests.length) statusClass = 'attending';
                else if (attendingGuests.length > 0) statusClass = 'partial';
                
                // Format time
                const time = new Date(invite.updated_at || invite.submitted_at);
                const timeStr = time.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                // Guest list
                let guestHtml = '';
                guests.forEach(g => {
                    const status = g.attending ? 'attending-yes' : 'attending-no';
                    const icon = g.attending ? '‚úì' : '‚úó';
                    guestHtml += `<span class="${status}">${icon} ${g.first_name} ${g.last_name}</span> `;
                });
                
                if (invite.plus_one_name) {
                    guestHtml += `<span class="attending-yes">‚úì ${invite.plus_one_name} (+1)</span> `;
                }
                
                // Events
                let events = [];
                if (invite.welcome_party) events.push('Welcome Party');
                if (invite.wedding) events.push('Wedding');
                const eventsHtml = events.length ? `<div class="activity-events">Events: ${events.join(', ')}</div>` : '';
                
                // Dietary
                let dietaryItems = [];
                guests.forEach(g => {
                    if (g.dietary_restrictions) dietaryItems.push(`${g.first_name}: ${g.dietary_restrictions}`);
                });
                if (invite.plus_one_dietary) dietaryItems.push(`${invite.plus_one_name || '+1'}: ${invite.plus_one_dietary}`);
                const dietaryHtml = dietaryItems.length ? `<div class="activity-dietary">üçΩ ${dietaryItems.join(' ¬∑ ')}</div>` : '';
                
                // Notes
                const notesHtml = invite.notes ? `<div class="activity-notes">"${invite.notes}"</div>` : '';
                
                // Setup interest
                const helperHtml = invite.setup_teardown_interest ? '<div class="activity-events">üôã Interested in helping with setup!</div>' : '';
                
                return `
                    <div class="activity-item ${statusClass}">
                        <div class="activity-household">${invite.household_name}</div>
                        <div class="activity-time">${timeStr}</div>
                        <div class="activity-guests">${guestHtml}</div>
                        ${eventsHtml}
                        ${dietaryHtml}
                        ${helperHtml}
                        ${notesHtml}
                    </div>
                `;
            }).join('');
        }
        
        function renderGuestTable(invites) {
            const tbody = document.getElementById('guest-table-body');
            
            let rows = [];
            
            // Helper to format date/time for tooltips
            function formatDateTime(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // Sort invites: Responded first, then Viewed, then Pending
            const sortedInvites = [...invites].sort((a, b) => {
                // Priority: submitted (0) > viewed (1) > pending (2)
                const getPriority = (inv) => {
                    if (inv.submitted_at) return 0;
                    if (inv.viewed_at) return 1;
                    return 2;
                };
                const priorityDiff = getPriority(a) - getPriority(b);
                if (priorityDiff !== 0) return priorityDiff;
                // Within same priority, sort by most recent activity
                const getDate = (inv) => new Date(inv.submitted_at || inv.viewed_at || inv.invited_at || 0);
                return getDate(b) - getDate(a);
            });
            
            sortedInvites.forEach(invite => {
                const guests = invite.guests || [];
                const guestCount = guests.length + (invite.plus_one_name ? 1 : 0);
                const rowSpan = guestCount > 1 ? ` rowspan="${guestCount}"` : '';
                const plusOneIndicator = invite.allows_plus_one ? ' <span title="Allows +1" style="color: var(--accent-color);">+1</span>' : '';
                const viewedIndicator = invite.viewed_at && !invite.submitted_at ? ' <span title="Viewed: ' + formatDateTime(invite.viewed_at) + '" style="color: #3498db;">üëÅÔ∏è</span>' : '';
                
                guests.forEach((guest, idx) => {
                    let statusBadge;
                    if (invite.submitted_at) {
                        const tooltip = 'RSVP submitted: ' + formatDateTime(invite.submitted_at);
                        statusBadge = guest.attending 
                            ? `<span class="status-badge yes" title="${tooltip}">Yes</span>`
                            : `<span class="status-badge no" title="${tooltip}">No</span>`;
                    } else if (invite.viewed_at) {
                        const tooltip = 'Viewed: ' + formatDateTime(invite.viewed_at);
                        statusBadge = `<span class="status-badge viewed" title="${tooltip}">Viewed</span>`;
                    } else if (invite.invited_at) {
                        const tooltip = 'Invitation sent: ' + formatDateTime(invite.invited_at);
                        statusBadge = `<span class="status-badge pending" title="${tooltip}">Pending</span>`;
                    } else {
                        statusBadge = '<span class="status-badge pending" title="Not yet invited">Pending</span>';
                    }
                    
                    // First guest row includes household name and edit button
                    if (idx === 0) {
                        rows.push(`
                            <tr>
                                <td>${guest.first_name} ${guest.last_name}${guest.is_child ? ' üë∂' : ''}</td>
                                <td${rowSpan}>${invite.household_name}${plusOneIndicator}${viewedIndicator}</td>
                                <td${rowSpan}><button class="btn-edit" onclick="openEditHouseholdModal('${invite.id}')" title="Edit household">‚úé</button></td>
                                <td>${statusBadge}</td>
                                <td>${guest.dietary_restrictions || '-'}</td>
                                <td>${invite.submitted_at ? (invite.welcome_party ? '‚úì' : '-') : '-'}</td>
                                <td>${invite.submitted_at ? (invite.wedding ? '‚úì' : '-') : '-'}</td>
                            </tr>
                        `);
                    } else {
                        rows.push(`
                            <tr>
                                <td>${guest.first_name} ${guest.last_name}${guest.is_child ? ' üë∂' : ''}</td>
                                <td>${statusBadge}</td>
                                <td>${guest.dietary_restrictions || '-'}</td>
                                <td>${invite.submitted_at ? (invite.welcome_party ? '‚úì' : '-') : '-'}</td>
                                <td>${invite.submitted_at ? (invite.wedding ? '‚úì' : '-') : '-'}</td>
                            </tr>
                        `);
                    }
                });
                
                // Add plus one if exists
                if (invite.plus_one_name) {
                    const isOnlyPlusOne = guests.length === 0;
                    if (isOnlyPlusOne) {
                        rows.push(`
                            <tr>
                                <td>${invite.plus_one_name} <em>(+1)</em></td>
                                <td>${invite.household_name}${plusOneIndicator}</td>
                                <td><button class="btn-edit" onclick="openEditHouseholdModal('${invite.id}')" title="Edit household">‚úé</button></td>
                                <td><span class="status-badge yes">Yes</span></td>
                                <td>${invite.plus_one_dietary || '-'}</td>
                                <td>${invite.welcome_party ? '‚úì' : '-'}</td>
                                <td>${invite.wedding ? '‚úì' : '-'}</td>
                            </tr>
                        `);
                    } else {
                        rows.push(`
                            <tr>
                                <td>${invite.plus_one_name} <em>(+1)</em></td>
                                <td><span class="status-badge yes">Yes</span></td>
                                <td>${invite.plus_one_dietary || '-'}</td>
                                <td>${invite.welcome_party ? '‚úì' : '-'}</td>
                                <td>${invite.wedding ? '‚úì' : '-'}</td>
                            </tr>
                        `);
                    }
                }
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // Needs Email functions
        function renderNeedsEmail(invites) {
            const needsEmail = invites.filter(inv => inv.email && inv.email.startsWith('NEEDS_EMAIL'));
            const list = document.getElementById('needs-email-list');
            const countEl = document.getElementById('needs-email-count');
            
            countEl.textContent = needsEmail.length;
            
            if (needsEmail.length === 0) {
                list.innerHTML = '<p class="no-needs-email">üéâ All households have email addresses!</p>';
                return;
            }
            
            list.innerHTML = needsEmail.map(inv => {
                const guestNames = inv.guests.map(g => `${g.first_name} ${g.last_name}`).join(', ');
                return `
                    <div class="needs-email-item" onclick="openModal('${inv.id}')">
                        <div class="needs-email-household">${inv.household_name}</div>
                        <div class="needs-email-guests">${guestNames}</div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(inviteId) {
            selectedInvite = allInvites.find(inv => inv.id === inviteId);
            if (!selectedInvite) return;
            
            document.getElementById('modal-household-name').textContent = selectedInvite.household_name;
            document.getElementById('modal-email-input').value = '';
            document.getElementById('modal-status').innerHTML = '';
            document.getElementById('modal-send-btn').disabled = false;
            document.getElementById('email-modal').style.display = 'flex';
            document.getElementById('modal-email-input').focus();
        }
        
        function closeModal() {
            document.getElementById('email-modal').style.display = 'none';
            selectedInvite = null;
        }
        
        function closeModalIfOverlay(event) {
            if (event.target.id === 'email-modal') {
                closeModal();
            }
        }
        
        async function sendInvitation() {
            const email = document.getElementById('modal-email-input').value.trim();
            const statusEl = document.getElementById('modal-status');
            const sendBtn = document.getElementById('modal-send-btn');
            
            if (!email || !email.includes('@')) {
                statusEl.innerHTML = '<span style="color: #dc3545;">Please enter a valid email address</span>';
                return;
            }
            
            sendBtn.disabled = true;
            statusEl.innerHTML = '<span style="color: #666;">Updating email...</span>';
            
            try {
                // Update the email in the database
                const { error: updateError } = await supabaseClient
                    .from('invites')
                    .update({ email: email })
                    .eq('id', selectedInvite.id);
                
                if (updateError) throw updateError;
                
                statusEl.innerHTML = '<span style="color: #666;">Sending invitation...</span>';
                
                // Call the send-invitations function
                const response = await supabaseClient.functions.invoke('send-invitations', {
                    body: { 
                        mode: 'all',
                        household_ids: [selectedInvite.id]
                    }
                });
                
                if (response.error) throw response.error;
                
                const result = response.data;
                if (result.sent === 1) {
                    statusEl.innerHTML = '<span style="color: #28a745;">‚úì Invitation sent successfully!</span>';
                    
                    // Update local data
                    selectedInvite.email = email;
                    renderNeedsEmail(allInvites);
                    
                    // Close modal after a brief delay
                    setTimeout(() => {
                        closeModal();
                    }, 1500);
                } else {
                    throw new Error(result.errors?.[0] || 'Failed to send invitation');
                }
                
            } catch (e) {
                console.error('Error:', e);
                statusEl.innerHTML = `<span style="color: #dc3545;">Error: ${e.message}</span>`;
                sendBtn.disabled = false;
            }
        }
        
        // New Household functions
        function openNewHouseholdModal() {
            document.getElementById('new-household-name').value = '';
            document.getElementById('new-household-email').value = '';
            document.getElementById('new-household-guests').value = '';
            document.getElementById('new-household-plus-one').checked = false;
            document.getElementById('new-household-status').innerHTML = '';
            document.getElementById('new-household-save-btn').disabled = false;
            document.getElementById('new-household-modal').style.display = 'flex';
            document.getElementById('new-household-name').focus();
        }
        
        function closeNewHouseholdModal() {
            document.getElementById('new-household-modal').style.display = 'none';
        }
        
        function closeNewHouseholdModalIfOverlay(event) {
            if (event.target.id === 'new-household-modal') {
                closeNewHouseholdModal();
            }
        }
        
        async function saveNewHousehold() {
            const householdName = document.getElementById('new-household-name').value.trim();
            const email = document.getElementById('new-household-email').value.trim();
            const guestsText = document.getElementById('new-household-guests').value.trim();
            const allowsPlusOne = document.getElementById('new-household-plus-one').checked;
            const statusEl = document.getElementById('new-household-status');
            const saveBtn = document.getElementById('new-household-save-btn');
            
            // Validation
            if (!householdName) {
                statusEl.innerHTML = '<span style="color: #dc3545;">Please enter a household name</span>';
                return;
            }
            if (!email || !email.includes('@')) {
                statusEl.innerHTML = '<span style="color: #dc3545;">Please enter a valid email</span>';
                return;
            }
            if (!guestsText) {
                statusEl.innerHTML = '<span style="color: #dc3545;">Please enter at least one guest name</span>';
                return;
            }
            
            // Parse guest names (one per line)
            const guestNames = guestsText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(name => {
                    const parts = name.split(' ');
                    const firstName = parts[0] || '';
                    const lastName = parts.slice(1).join(' ') || '';
                    return { firstName, lastName };
                });
            
            if (guestNames.length === 0) {
                statusEl.innerHTML = '<span style="color: #dc3545;">Please enter at least one guest name</span>';
                return;
            }
            
            saveBtn.disabled = true;
            statusEl.innerHTML = '<span style="color: #666;">Creating household...</span>';
            
            try {
                // Create the invite
                const { data: invite, error: inviteError } = await supabaseClient
                    .from('invites')
                    .insert({
                        household_name: householdName,
                        email: email,
                        allows_plus_one: allowsPlusOne
                    })
                    .select()
                    .single();
                
                if (inviteError) throw inviteError;
                
                // Create the guests
                const guestsToInsert = guestNames.map(g => ({
                    invite_id: invite.id,
                    first_name: g.firstName,
                    last_name: g.lastName
                }));
                
                const { error: guestsError } = await supabaseClient
                    .from('guests')
                    .insert(guestsToInsert);
                
                if (guestsError) throw guestsError;
                
                statusEl.innerHTML = '<span style="color: #666;">Sending invitation...</span>';
                
                // Send the invitation
                const response = await supabaseClient.functions.invoke('send-invitations', {
                    body: {
                        household_ids: [invite.id]
                    }
                });
                
                if (response.error) throw response.error;
                
                const result = response.data;
                if (result.sent === 1) {
                    statusEl.innerHTML = '<span style="color: #28a745;">‚úì Household created and invitation sent!</span>';
                    
                    // Reload data
                    setTimeout(() => {
                        closeNewHouseholdModal();
                        loadData();
                    }, 1500);
                } else {
                    statusEl.innerHTML = '<span style="color: #ffc107;">‚ö† Household created but invitation may not have sent. Check the dashboard.</span>';
                    setTimeout(() => {
                        closeNewHouseholdModal();
                        loadData();
                    }, 2000);
                }
                
            } catch (e) {
                console.error('Error:', e);
                statusEl.innerHTML = `<span style="color: #dc3545;">Error: ${e.message}</span>`;
                saveBtn.disabled = false;
            }
        }
        
        // Edit Household functions
        let editingInviteId = null;
        
        function openEditHouseholdModal(inviteId) {
            const invite = allInvites.find(inv => inv.id === inviteId);
            if (!invite) return;
            
            editingInviteId = inviteId;
            
            document.getElementById('edit-household-title').textContent = invite.household_name;
            const guestNames = invite.guests?.map(g => `${g.first_name} ${g.last_name}`).join(', ') || 'No guests';
            document.getElementById('edit-household-guests').textContent = guestNames;
            
            // Set current values
            document.getElementById('edit-allows-plus-one').checked = invite.allows_plus_one || false;
            document.getElementById('edit-plus-one-name').value = invite.plus_one_name || '';
            document.getElementById('edit-plus-one-dietary').value = invite.plus_one_dietary || '';
            
            // Show invite status
            const inviteStatusEl = document.getElementById('edit-invite-status');
            if (!invite.email || invite.email.startsWith('NEEDS_EMAIL')) {
                inviteStatusEl.innerHTML = '‚ö†Ô∏è No email address on file';
            } else if (invite.invited_at) {
                const invitedDate = new Date(invite.invited_at).toLocaleDateString();
                inviteStatusEl.innerHTML = `‚úì Invitation sent on ${invitedDate} to ${invite.email}`;
            } else {
                inviteStatusEl.innerHTML = `üìß Email: ${invite.email} (not yet sent)`;
            }
            
            // Show/hide plus one fields based on checkbox
            updatePlusOneFields();
            
            document.getElementById('edit-household-status').innerHTML = '';
            document.getElementById('edit-household-modal').style.display = 'flex';
        }
        
        function updatePlusOneFields() {
            const allowsPlusOne = document.getElementById('edit-allows-plus-one').checked;
            document.getElementById('edit-plus-one-section').style.display = allowsPlusOne ? 'block' : 'none';
            
            // Show dietary field if there's a plus one name or allow is checked
            const plusOneName = document.getElementById('edit-plus-one-name').value;
            document.getElementById('edit-plus-one-dietary-section').style.display = 
                (allowsPlusOne && plusOneName) ? 'block' : 'none';
        }
        
        // Add event listeners for the edit form
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('edit-allows-plus-one')?.addEventListener('change', updatePlusOneFields);
            document.getElementById('edit-plus-one-name')?.addEventListener('input', updatePlusOneFields);
        });
        
        function closeEditHouseholdModal() {
            document.getElementById('edit-household-modal').style.display = 'none';
            editingInviteId = null;
        }
        
        function closeEditHouseholdModalIfOverlay(event) {
            if (event.target === event.currentTarget) {
                closeEditHouseholdModal();
            }
        }
        
        async function saveHouseholdEdit() {
            if (!editingInviteId) return;
            
            const saveBtn = document.getElementById('edit-household-save-btn');
            const statusEl = document.getElementById('edit-household-status');
            
            saveBtn.disabled = true;
            statusEl.className = 'modal-status loading';
            statusEl.innerHTML = 'Saving changes...';
            statusEl.style.display = 'block';
            
            try {
                const allowsPlusOne = document.getElementById('edit-allows-plus-one').checked;
                const plusOneName = document.getElementById('edit-plus-one-name').value.trim();
                const plusOneDietary = document.getElementById('edit-plus-one-dietary').value.trim();
                
                const updateData = {
                    allows_plus_one: allowsPlusOne
                };
                
                // Only update plus one fields if allows_plus_one is true
                if (allowsPlusOne) {
                    if (plusOneName) {
                        updateData.plus_one_name = plusOneName;
                        updateData.plus_one_dietary = plusOneDietary || null;
                    }
                } else {
                    // If disabling plus one, clear the plus one data
                    updateData.plus_one_name = null;
                    updateData.plus_one_dietary = null;
                }
                
                const { error } = await supabaseClient
                    .from('invites')
                    .update(updateData)
                    .eq('id', editingInviteId);
                
                if (error) throw error;
                
                statusEl.className = 'modal-status success';
                statusEl.innerHTML = '‚úì Household updated!';
                
                // Reload data and close modal
                setTimeout(() => {
                    closeEditHouseholdModal();
                    loadData();
                }, 1000);
                
            } catch (e) {
                console.error('Error:', e);
                statusEl.className = 'modal-status error';
                statusEl.innerHTML = `Error: ${e.message}`;
                saveBtn.disabled = false;
            }
        }
        
        async function addGuestToHousehold() {
            if (!editingInviteId) return;
            
            const firstName = document.getElementById('add-guest-first-name').value.trim();
            const lastName = document.getElementById('add-guest-last-name').value.trim();
            const isChild = document.getElementById('add-guest-is-child').checked;
            const statusEl = document.getElementById('edit-household-status');
            
            if (!firstName) {
                statusEl.className = 'modal-status error';
                statusEl.innerHTML = 'Please enter a first name';
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'modal-status loading';
            statusEl.innerHTML = 'Adding guest...';
            statusEl.style.display = 'block';
            
            try {
                const { error } = await supabaseClient
                    .from('guests')
                    .insert({
                        invite_id: editingInviteId,
                        first_name: firstName,
                        last_name: lastName,
                        is_child: isChild
                    });
                
                if (error) throw error;
                
                // Clear form fields
                document.getElementById('add-guest-first-name').value = '';
                document.getElementById('add-guest-last-name').value = '';
                document.getElementById('add-guest-is-child').checked = false;
                
                statusEl.className = 'modal-status success';
                statusEl.innerHTML = `‚úì Added ${firstName} ${lastName}${isChild ? ' üë∂' : ''}!`;
                
                // Reload data to update the guest list display
                await loadData();
                
                // Update the modal's guest list display
                const invite = allInvites.find(inv => inv.id === editingInviteId);
                if (invite) {
                    const guestNames = invite.guests?.map(g => `${g.first_name} ${g.last_name}`).join(', ') || 'No guests';
                    document.getElementById('edit-household-guests').textContent = guestNames;
                }
                
            } catch (e) {
                console.error('Error:', e);
                statusEl.className = 'modal-status error';
                statusEl.innerHTML = `Error: ${e.message}`;
            }
        }
        
        async function resendInvitation() {
            if (!editingInviteId) return;
            
            const invite = allInvites.find(inv => inv.id === editingInviteId);
            if (!invite) return;
            
            const statusEl = document.getElementById('edit-household-status');
            
            if (!invite.email || invite.email.startsWith('NEEDS_EMAIL')) {
                statusEl.className = 'modal-status error';
                statusEl.innerHTML = 'No email address on file. Add one in the Needs Email section first.';
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'modal-status loading';
            statusEl.innerHTML = 'Sending invitation...';
            statusEl.style.display = 'block';
            
            try {
                const response = await supabaseClient.functions.invoke('send-invitations', {
                    body: {
                        household_ids: [editingInviteId]
                    }
                });
                
                if (response.error) throw response.error;
                
                const result = response.data;
                if (result.sent === 1) {
                    statusEl.className = 'modal-status success';
                    statusEl.innerHTML = `‚úì Invitation sent to ${invite.email}!`;
                    
                    // Update the invite status display
                    document.getElementById('edit-invite-status').innerHTML = `‚úì Invitation just sent to ${invite.email}`;
                    
                    // Reload data
                    await loadData();
                } else {
                    statusEl.className = 'modal-status error';
                    statusEl.innerHTML = `Failed to send. ${result.message || 'Unknown error'}`;
                }
                
            } catch (e) {
                console.error('Error:', e);
                statusEl.className = 'modal-status error';
                statusEl.innerHTML = `Error: ${e.message}`;
            }
        }
        
        // Check for existing session
        document.addEventListener('DOMContentLoaded', function() {
            const savedKey = sessionStorage.getItem('adminKey');
            if (savedKey) {
                document.getElementById('admin-password').value = savedKey;
                attemptLogin();
            }
            
            // Allow enter key to login
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') attemptLogin();
            });
            
            // Allow enter key in email modal
            document.getElementById('modal-email-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendInvitation();
            });
        });
    </script>
</body>
</html>
